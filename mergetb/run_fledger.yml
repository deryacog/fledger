- name: Run fledger container
  docker_container:
    name: "fledger_{{ inventory_hostname }}"
    image: "{{ docker_image }}"
    state: started
    detach: true
    volumes:
      - "{{ data_dir }}:/fledger/data"
    command: >
      --config /fledger/data
      --name {{ inventory_hostname }}
      {% if inventory_hostname == 'node-1' %}
      --path-len {{ path_len }}
      {% endif %}
      -s ws://{{ signal_node }}:8765
      --retry {{ retry }}
      --loopix-config-name {{ current_file }}
    network_mode: host
    log_driver: "json-file"
    output_logs: yes
    log_options:
      max-size: "10m"
      max-file: "4"
    env:
      RUST_BACKTRACE: "full"
  register: fledger_container

- name: Wait for 2 minutes while fledger runs
  pause:
    seconds: 10

- name: Stop existing fledger container if present
  docker_container:
    name: "fledger_{{ inventory_hostname }}"
    state: stopped
  ignore_errors: false

- name: Fetch a file from the remote node
  fetch:
    src: /fledger/data/metrics_{{ current_file }}.txt
    dest: "./metrics/metrics_{{ current_file }}_{{ inventory_hostname }}.txt"
