---
- name: Setup and run signal tasks
  hosts: SIGNAL_NODE
  vars:
    docker_image: deryacog/flsignal:latest
    container_name: flsignal
  tasks:
    - name: Remove existing flsignal container if present
      docker_container:
        name: "{{ container_name }}"
        state: absent

    - name: Pull flsignal Docker image
      docker_image:
        name: "{{ docker_image }}"
        source: pull
        force_source: true

    - name: Run flsignal container
      docker_container:
        name: "{{ container_name }}"
        image: "{{ docker_image }}"
        state: started
        detach: true
        ports:
          - "8765:8765"
        command: >
          -v
        log_driver: "json-file"
        log_options:
          max-size: "10m"
          max-file: "4"

    - name: Wait for 10 seconds to ensure flsignal is running
      pause:
        seconds: 10

- name: Setup and run fledger tasks
  hosts: FLEDGER_TRY
  vars:
    path_len: 3
    retry: 0
    docker_image: deryacog/fledger:latest
    signal_node: "{{ hostvars[groups['SIGNAL_NODE'][0]].ansible_host }}"
    simul_path: /home/dcog/data
  tasks:
    - name: Remove existing fledger container if present
      docker_container:
        name: "fledger_{{ inventory_hostname }}"
        state: absent

    - name: Pull fledger Docker image
      docker_image:
        name: "{{ docker_image }}"
        source: pull
        force_source: true

    - name: Ensure /home/dcog/data directory exists
      file:
        path: "{{ simul_path }}"
        state: directory

    - name: Run fledger container
      docker_container:
        name: "fledger_{{ inventory_hostname }}"
        image: "{{ docker_image }}"
        state: started
        detach: true
        volumes:
          - "{{ simul_path }}:/fledger/data"
          - "/home/dcog/loopix_core_config.yaml:/fledger/loopix_core_config.yaml"
        command: >
          --config /fledger/data
          --name {{ inventory_hostname }}
          -v
          -s ws://{{ signal_node }}:8765
        log_driver: "json-file"
        log_options:
          max-size: "10m"
          max-file: "4"
      register: fledger_container

    - name: Wait for 60 seconds
      pause:
        seconds: 60

    - name: Save container logs to logs.txt
      shell: "docker logs {{ fledger_container.container.Id }} > /home/dcog/data/logs.txt 2>&1"

# - name: Cleanup signal processes
#   hosts: SIGNAL_NODE
#   become: yes
#   tasks:
#     - name: Stop flsignal container
#       docker_container:
#         name: flsignal
#         state: stopped
#       ignore_errors: true

# - name: Cleanup fledger processes
#   hosts: FLEDGER_NODES
#   become: yes
#   tasks:
#     - name: Stop fledger container
#       docker_container:
#         name: "fledger_{{ inventory_hostname }}"
#         state: stopped
#       ignore_errors: true